generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum CompanyTypesEnum {
  MATRIZ
  FILIAL
  MASTER
}

enum CompanyEmviromentTypesEnum {
  SUPPORT
  OPERATION
  ADMINISTRATIVE
}

enum HierarchyEnum {
  DIRECTORY 
  MANAGEMENT
  SECTOR
  SUB_SECTOR
  OFFICE
  SUB_OFFICE
}

enum RiskFactorsEnum {
  BIO 
  QUI
  FIS
  ERG
  ACI
}

enum StatusEnum {
  ACTIVE
  PROGRESS
  INACTIVE
  PENDING
  CANCELED
}

enum MeasuresTypeEnum {
  ADM
  ENG
}

model Activity {
  id    Int     @default(autoincrement()) @id
  code String @unique
  name String
  created_at DateTime @default(now())
  company_primary_activity Company[] @relation(name: "primary_activity")
  company_secondary_activity Company[] @relation(name: "secondary_activity")
}

model Address {
  id   String    @id @default(uuid())
  companyId String
  cep String 
  street String?
  number String?
  complement String?
  neighborhood String?
  city String?
  state String?
  workspaceId String?
  workspace Workspace? @relation(fields: [id,companyId], references: [id,companyId], onDelete: Cascade, onUpdate: Cascade)
  
  @@unique([workspaceId, companyId])
}

model AddressCompany {
  id   String    @id @default(uuid())
  cep String 
  street String?
  number String?
  complement String?
  neighborhood String?
  city String?
  state String?
  companyId String
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model Checklist {
  id    Int     @default(autoincrement())
  status StatusEnum @default(PROGRESS)
  name String 
  companyId String
  system Boolean
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  data ChecklistData?
  created_at DateTime @default(now())

  @@id([id, companyId])
} 

model ChecklistData {
  json Json
  companyId String
  checklistId    Int  
  checklist Checklist @relation(fields: [checklistId,companyId], references: [id,companyId], onDelete: Cascade, onUpdate: Cascade)

  @@id([checklistId, companyId])
} 

model Company {
  id   String    @id @default(uuid())
  cnpj String
  name String  
  fantasy String?
  description String?
  size String?
  legal_nature String?
  cadastral_situation String?
  activity_start_date String?
  cadastral_situation_date String?
  legal_nature_code String?
  cadastral_situation_description String?
  isConsulting Boolean @default(false)
  licenseId Int? 
  phone String?
  email String?
  riskDegree Int?
  operatonTime String?
  logoUrl String?
  responsableName String?
  mission String?
  vision String?
  values String?
  created_at DateTime @default(now())
  deleted_at DateTime? 
  updated_at  DateTime   @updatedAt
  status StatusEnum @default(ACTIVE)
  type CompanyTypesEnum @default(MATRIZ)
  users UserCompany[]
  workspace Workspace[]
  address AddressCompany?
  primary_activity Activity[] @relation(name: "primary_activity")
  secondary_activity Activity[] @relation(name: "secondary_activity")
  employees Employee[] 
  invites InviteUsers[] 
  receivingServiceContracts Contract[]
  applyingServiceContracts Contract[]  @relation(name: "contracts")
  license License? @relation(name:"license",fields: [licenseId], references: [id], onDelete: Restrict, onUpdate: Cascade) 
  riskFactors RiskFactors[] 
  homogeneousGroup HomogeneousGroup[] 
  generateSource GenerateSource[] 
  recMed RecMed[] 
  hierarchy Hierarchy[] 
  databaseTable DatabaseTable[] 
  checklist Checklist[] 
  riskFactorData RiskFactorData[] 
  riskFactorGroupData RiskFactorGroupData[] 
  riskFactorDocument RiskFactorDocument[] 
}

model CompanyEnvironment {
  id   String    @id @default(uuid())
  name String  
  description String?
  vision String?
  created_at DateTime @default(now())
  deleted_at DateTime? 
  updated_at  DateTime   @updatedAt
  type CompanyEmviromentTypesEnum 
  workspaceId String
  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Restrict, onUpdate: Cascade) 
  riskFactors RiskFactors[] 
  hierarchy Hierarchy[] 
  parentEnvironmentId String
  parentEnvironment CompanyEnvironment @relation(name: "parent_enviroment",fields: [parentEnvironmentId], references: [id], onDelete: Restrict, onUpdate: Cascade) 
  childEnvironments CompanyEnvironment[] @relation(name: "parent_enviroment")
}

model Contract {
  receivingServiceCompany   Company @relation(fields: [receivingServiceCompanyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  applyingServiceCompany  Company @relation(name: "contracts", fields: [applyingServiceCompanyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  applyingServiceCompanyId String 
  receivingServiceCompanyId String 
  status StatusEnum @default(ACTIVE)
  created_at DateTime @default(now())
 
  @@id([applyingServiceCompanyId, receivingServiceCompanyId])
}

model DatabaseTable {
  id    Int     @default(autoincrement())
  name String 
  version Int  @default(1)
  companyId String
  system Boolean
  status StatusEnum @default(ACTIVE)
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  created_at DateTime @default(now())
  updated_at  DateTime   @updatedAt

  @@id([id, companyId])
} 

model Employee {
  id    Int   @id  @default(autoincrement())
  created_at DateTime @default(now())
  updated_at  DateTime   @updatedAt
  status StatusEnum @default(ACTIVE)
  name String 
  cpf String 
  companyId String
  hierarchyId String
  workspaces Workspace[]
  hierarchy Hierarchy @relation(fields: [hierarchyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  
  @@unique([id, companyId])
} 

model Epi {
  id    Int     @default(autoincrement()) @id
  ca String
  isValid Boolean?  
  national Boolean @default(true)
  expiredDate DateTime?
  description String @default("")
  report String @default("")
  restriction String @default("")
  observation String @default("")
  equipment String @default("")
  status StatusEnum @default(ACTIVE)
  created_at DateTime @default(now())
  deleted_at DateTime? 
  riskFactorData RiskFactorData[]

  @@index(ca)
  @@unique([ca, status])
} 

model GenerateSource {
  id    String   @id  @default(uuid())
  riskId    String    
  name String
  companyId String
  system Boolean
  created_at DateTime @default(now())
  status StatusEnum @default(ACTIVE)
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  risk RiskFactors @relation(fields: [riskId,companyId], references: [id,companyId], onDelete: Cascade, onUpdate: Cascade)
  deleted_at DateTime? 
  recMeds RecMed[] 
  riskFactorData RiskFactorData[]

  @@unique([id, companyId])
} 

model Hierarchy {
  id    String     @default(uuid())  @id
  created_at DateTime @default(now())
  status StatusEnum @default(ACTIVE)
  type HierarchyEnum 
  description String @default("")
  realDescription String @default("")
  name String   
  companyId String
  parentId  String?
  workspaces Workspace[]
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  parent Hierarchy?  @relation(name: "children_parent", fields: [parentId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  children Hierarchy[] @relation(name: "children_parent")
  employees Employee[] 
  companyEnvironment CompanyEnvironment[] 
  hierarchyOnHomogeneous HierarchyOnHomogeneous[]
  riskFactorDatas RiskFactorData[] 

  @@unique([id, companyId])
  @@index(companyId)
}

model HierarchyOnHomogeneous {
  hierarchy       Hierarchy     @relation(fields: [hierarchyId], references: [id])
  hierarchyId     String
  homogeneousGroup   HomogeneousGroup @relation(fields: [homogeneousGroupId], references: [id])
  homogeneousGroupId     String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId     String

  @@id([hierarchyId, homogeneousGroupId, workspaceId])
}

model HomogeneousGroup {
  id    String     @default(uuid()) @id
  name String
  description String 
  companyId String
  status StatusEnum @default(ACTIVE)
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  hierarchyOnHomogeneous HierarchyOnHomogeneous[] 
  created_at DateTime @default(now())
  riskFactorData RiskFactorData[] 
  
  @@unique([name, companyId])
  @@index(companyId)
}

model InviteUsers {
  id   String @id @default(uuid())
  expires_date DateTime
  companyId String
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  email String 
  roles String[]
  permissions String[]
}

model License {
  id    Int     @default(autoincrement()) @id
  companies   Company[] @relation(name:"license")
  companyId String  @unique
  status StatusEnum @default(ACTIVE)
  created_at DateTime @default(now())

  @@index(companyId)
}

model RecMed {
  id    String   @id  @default(uuid())
  riskId    String    
  recName String? 
  medName String? 
  companyId String
  generateSourceId    String?    
  system Boolean 
  medType MeasuresTypeEnum?
  status StatusEnum @default(ACTIVE)
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  risk RiskFactors @relation(fields: [riskId,companyId], references: [id,companyId], onDelete: Cascade, onUpdate: Cascade)
  generateSource GenerateSource? @relation(fields: [generateSourceId,companyId], references: [id,companyId], onDelete: Cascade, onUpdate: Cascade)
  deleted_at DateTime? 
  created_at DateTime @default(now())
  recs RiskFactorData[]  @relation(name: "recs")
  engs RiskFactorData[]  @relation(name: "engs")
  adms RiskFactorData[]  @relation(name: "adms")

  @@unique([id, companyId])
} 

model RefreshToken {
  id   String @id @default(uuid())
  refresh_token String
  expires_date DateTime
  created_at DateTime @default(now())
  userId Int
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model RiskFactors {
  id    String   @id  @default(uuid())
  name String 
  companyId String
  severity Int  @default(0)
  system Boolean @default(false)
  appendix String? 
  risk String? 
  propagation String[] 
  exame String?
  symptoms String?
  method String?
  unit String?
  cas String?
  breather String?
  nr15lt String?
  twa String?
  stel String?
  ipvs String?
  pv String?
  pe String?
  carnogenicityACGIH String?
  carnogenicityLinach String?
  status StatusEnum @default(ACTIVE)
  type RiskFactorsEnum
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  created_at DateTime @default(now())
  deleted_at DateTime? 
  recMed RecMed[]
  generateSource GenerateSource[]
  representAll Boolean @default(false)
  riskFactorData RiskFactorData[]
  riskFactorProbability RiskFactorProbability[]
  companyEnvironment CompanyEnvironment[] 
  
  @@unique([id, companyId])
}

model RiskFactorDocument {
  id    String   @id  @default(uuid())
  fileUrl String
  name String 
  description String @default("")
  version String  @default("1")
  companyId String
  riskGroupId String
  workspaceName String
  workspaceId String
  workspace Workspace @relation(fields: [workspaceId,companyId], references: [id,companyId], onDelete: Cascade, onUpdate: Cascade)
  status StatusEnum @default(ACTIVE)
  created_at DateTime @default(now())
  updated_at  DateTime   @updatedAt
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  riskGroup RiskFactorGroupData @relation(fields: [riskGroupId, companyId], references: [id, companyId], onDelete: Restrict, onUpdate: Cascade)

  @@unique([id, companyId])
} 

model RiskFactorGroupData {
  id    String   @id  @default(uuid())
  name String?
  created_at DateTime @default(now())
  companyId String
  source String?
  elaboratedBy String?
  revisionBy String?
  approvedBy String?
  visitDate DateTime?
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  data RiskFactorData[]
  docs RiskFactorDocument[]
  status StatusEnum @default(PROGRESS)

  @@unique([id, companyId])
}

model RiskFactorData {
  id    String   @id  @default(uuid())
  probability Int?
  probabilityAfter Int?
  probabilityCalc RiskFactorProbability? @relation(name: "RiskFactorProbabilityBefore")
  probabilityAfterCalc RiskFactorProbability? @relation(name: "RiskFactorProbabilityAfter")
  companyId String
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  riskId    String
  riskFactor RiskFactors @relation(fields: [riskId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  homogeneousGroupId String?
  homogeneousGroup HomogeneousGroup? @relation(fields: [homogeneousGroupId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  hierarchyId String?
  hierarchy Hierarchy? @relation(fields: [hierarchyId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  riskFactorGroupDataId String
  riskFactorGroupData RiskFactorGroupData @relation(fields: [riskFactorGroupDataId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  generateSources GenerateSource[]
  recs RecMed[]  @relation(name: "recs")
  engs RecMed[]  @relation(name: "engs")
  adms RecMed[]  @relation(name: "adms")
  epis Epi[]

  @@unique([id, companyId])
  @@unique([homogeneousGroupId, riskId, riskFactorGroupDataId])
  @@unique([hierarchyId, riskId, riskFactorGroupDataId])
  @@unique([id, riskId, riskFactorGroupDataId])
}

model RiskFactorProbability {
  id    String   @id  @default(uuid())
  intensity Int?
  intensityResult Float?
  intensityLt Float?
  minDurationJT Int?
  minDurationEO Int?
  chancesOfHappening Int?
  frequency Int?
  history Int?
  medsImplemented Int?
  riskFactorDataAfterId String?
  riskFactorDataId String?
  riskId    String
  riskFactorGroupDataId String?
  riskFactor RiskFactors @relation(fields: [riskId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  riskFactorData RiskFactorData? @relation(name: "RiskFactorProbabilityBefore", fields: [riskFactorDataId,riskId,riskFactorGroupDataId], references: [id,riskId,riskFactorGroupDataId], onDelete: Restrict, onUpdate: Cascade)
  riskFactorDataAfter RiskFactorData? @relation(name: "RiskFactorProbabilityAfter", fields: [riskFactorDataAfterId,riskId,riskFactorGroupDataId], references: [id,riskId,riskFactorGroupDataId], onDelete: Restrict, onUpdate: Cascade)
}

model User {
  id    Int     @default(autoincrement()) @id
  email String  @unique
  name String? 
  password String
  created_at DateTime @default(now())
  updated_at  DateTime   @updatedAt
  deleted_at DateTime? 
  refresh_token RefreshToken[]
  companies UserCompany[]
}

model UserCompany {
  roles String[]
  permissions String[]
  status StatusEnum @default(ACTIVE)
  userId Int
  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade) 
  companyId String
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade, onUpdate: Cascade) 
  created_at DateTime @default(now())
  updated_at  DateTime   @updatedAt
  
  @@id([companyId, userId])
}

model Workspace {
  id    String  @id   @default(uuid()) 
  name String  
  abbreviation String?
  description String?  
  cnpj String?  
  created_at DateTime @default(now())
  updated_at  DateTime   @updatedAt
  companyId String
  status StatusEnum @default(ACTIVE)
  company Company @relation(fields: [companyId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  address Address?
  employee Employee[]
  riskFactorDocument RiskFactorDocument[]
  hierarchyOnHomogeneous HierarchyOnHomogeneous[]
  hierarchy Hierarchy[]
  companyEnvironment CompanyEnvironment[]

  @@unique([abbreviation, companyId])
  @@unique([id, companyId])
}


